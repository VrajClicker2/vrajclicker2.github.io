<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vraj Clicker 2 - Secure Edition</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #1e272e; --text: #ffffff; --accent: #00d2d3; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; overflow-x: hidden; }
        .container { background: #2f3640; padding: 2rem; border-radius: 20px; text-align: center; width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); position: relative; }
        .hidden { display: none; }
        
        /* Input Styling */
        .auth-box { display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        
        /* Game UI */
        #game-btn { width: 150px; height: 150px; border-radius: 50%; background: var(--accent); border: 8px solid #01a3a4; font-size: 1.5rem; margin: 20px auto; cursor: pointer; color: white; transition: 0.1s; }
        #game-btn:active { transform: scale(0.95); }
        .stats { font-size: 1.5rem; margin: 15px 0; color: var(--gold); font-weight: bold; }
        
        /* Leaderboard */
        .leaderboard { margin-top: 30px; background: #1e272e; padding: 15px; border-radius: 12px; text-align: left; }
        table { width: 100%; font-size: 0.9rem; border-collapse: collapse; }
        th { border-bottom: 2px solid #555; padding-bottom: 8px; }
        td { padding: 8px 5px; }
        .top1 { color: var(--gold); font-weight: bold; }

        /* Verification Screen */
        #verify-screen { color: var(--accent); padding: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Vraj Clicker 2</h1>

        <div id="auth-ui" class="auth-box">
            <div id="signup-fields">
                <input type="text" id="username" placeholder="Choose a Username">
            </div>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="pass" placeholder="Password (6+ chars)">
            <button id="login-btn">Login</button>
            <p style="font-size: 0.8rem;">New player?</p>
            <button id="signup-btn" style="background:#4834d4">Create Account</button>
        </div>

        <div id="verify-ui" class="hidden">
            <div id="verify-screen">
                <h2>üì® Verify your email!</h2>
                <p>We sent a link to <b id="user-email-display"></b>.</p>
                <p>Please click it, then click "I've Verified" below.</p>
                <button id="check-verify-btn">I've Verified My Email</button>
                <button id="resend-btn" style="background:none; color:white; font-size:0.8rem; margin-top:10px;">Resend Email</button>
            </div>
            <button onclick="location.reload()" style="background:#eb4d4b; margin-top:20px;">Cancel / Logout</button>
        </div>

        <div id="game-ui" class="hidden">
            <h3 id="display-name">Player</h3>
            <div class="stats">Clicks: <span id="score">0</span></div>
            <button id="game-btn">CLICK!</button>
            <p>Auto-Clickers: <span id="auto-count">0</span></p>
            <button id="buy-auto" style="background: #27ae60">Buy Auto (Cost: <span id="cost">10</span>)</button>

            <div class="leaderboard">
                <h4>üèÜ Global Leaderboard</h4>
                <table>
                    <thead><tr><th>Rank</th><th>Player</th><th>Score</th></tr></thead>
                    <tbody id="lb-body"></tbody>
                </table>
            </div>
            <button id="logout-btn" style="background:#eb4d4b; margin-top: 25px;">Logout</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwg2ZSpQspAD-o19AZCOHcrl9VnYc_sdk",
            authDomain: "vraj-clicker-2.firebaseapp.com",
            projectId: "vraj-clicker-2",
            storageBucket: "vraj-clicker-2.firebasestorage.app",
            messagingSenderId: "162243172716",
            appId: "1:162243172716:web:874a1f8be471a9f0d83b49",
            measurementId: "G-SBJ4W7JRRL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let userData = { score: 0, autoClickers: 0, name: "Newbie" };

        // --- SIGNUP LOGIC ---
        document.getElementById('signup-btn').onclick = () => {
            const user = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;

            if(!user || user.length < 3) return alert("Username too short!");

            createUserWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    // 1. Send verification email
                    sendEmailVerification(userCredential.user);
                    // 2. Save username to Database
                    set(ref(db, 'users/' + userCredential.user.uid), {
                        name: user,
                        score: 0,
                        autoClickers: 0
                    });
                }).catch(err => alert(err.message));
        };

        // --- LOGIN LOGIC ---
        document.getElementById('login-btn').onclick = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        };

        // --- AUTH OBSERVER (The Brain) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-ui').classList.add('hidden');
                
                if (user.emailVerified) {
                    // Access Granted
                    document.getElementById('verify-ui').classList.add('hidden');
                    document.getElementById('game-ui').classList.remove('hidden');
                    startSyncing(user);
                } else {
                    // Show Verification Screen
                    document.getElementById('verify-ui').classList.remove('hidden');
                    document.getElementById('user-email-display').innerText = user.email;
                }
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('game-ui').classList.add('hidden');
            }
        });

        // Check if user verified while on the page
        document.getElementById('check-verify-btn').onclick = () => {
            auth.currentUser.reload().then(() => {
                if(auth.currentUser.emailVerified) location.reload();
                else alert("Not verified yet! Check your spam folder.");
            });
        };

        document.getElementById('resend-btn').onclick = () => {
            sendEmailVerification(auth.currentUser).then(() => alert("Email Resent!"));
        };

        // --- GAME LOGIC ---
        function startSyncing(user) {
            onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                if(snapshot.exists()) {
                    userData = snapshot.val();
                    updateUI();
                }
            });
        }

        document.getElementById('game-btn').onclick = () => {
            userData.score += 1;
            saveData();
        };

        document.getElementById('buy-auto').onclick = () => {
            let cost = Math.floor(10 * Math.pow(1.5, userData.autoClickers));
            if(userData.score >= cost) {
                userData.score -= cost;
                userData.autoClickers += 1;
                saveData();
            }
        };

        function saveData() {
            if(auth.currentUser && auth.currentUser.emailVerified) {
                update(ref(db, 'users/' + auth.currentUser.uid), userData);
            }
        }

        function updateUI() {
            document.getElementById('score').innerText = Math.floor(userData.score);
            document.getElementById('auto-count').innerText = userData.autoClickers;
            document.getElementById('cost').innerText = Math.floor(10 * Math.pow(1.5, userData.autoClickers));
            document.getElementById('display-name').innerText = `Welcome, ${userData.name}!`;
        }

        // --- GLOBAL LEADERBOARD ---
        const lbRef = query(ref(db, 'users'), orderByChild('score'), limitToLast(5));
        onValue(lbRef, (snapshot) => {
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = "";
            let players = [];
            snapshot.forEach(child => { players.push(child.val()); });
            players.reverse().forEach((p, i) => {
                tbody.innerHTML += `<tr class="${i==0?'top1':''}"><td>#${i+1}</td><td>${p.name}</td><td>${Math.floor(p.score)}</td></tr>`;
            });
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth);
        
        // Loop
        setInterval(() => {
            if(auth.currentUser && auth.currentUser.emailVerified && userData.autoClickers > 0) {
                userData.score += (userData.autoClickers * 0.1);
                saveData();
            }
        }, 1000);
    </script>
</body>
</html>
